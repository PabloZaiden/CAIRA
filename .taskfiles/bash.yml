#  yaml-language-server: $schema=https://taskfile.dev/schema.json
# docs: https://taskfile.dev
---
version: "3"

includes:
  internal: internal.yml

tasks:
  # * Install shellcheck
  install:shellcheck:
    desc: Install shellcheck
    cmds:
      - for: [shellcheck]
        task: internal:install:brew
        vars:
          APP: "{{.ITEM}}"
        platforms: [darwin]
      - cmd: |
          sudo apt -o DPkg::Lock::Timeout=-1 update \
            && sudo apt -o DPkg::Lock::Timeout=-1 install shellcheck -y
        platforms: [linux]

  # * Install shfmt
  install:shfmt:
    desc: Install shfmt
    vars:
      SHFMT_VERSION: "v3.12.0"
      SHFMT_URL: "https://github.com/mvdan/sh/releases/download/{{.SHFMT_VERSION}}/shfmt_{{.SHFMT_VERSION}}_{{.OS}}_{{.ARCH}}"
    cmds:
      - cmd: |
          curl -L "{{.SHFMT_URL}}" > ~/shfmt
          sudo install ~/shfmt /usr/local/bin/shfmt && rm -f ~/shfmt

  # * Tools
  tools:
    desc: Install Bash tools
    cmds:
      - task: install:shellcheck
      - task: install:shfmt

  # * Lint
  lint:
    desc: Lint Bash files
    vars:
      SHELL_FILES:
        sh: |
          shfmt --find . | grep -v -E '\./\.git/|\./node_modules/|/\.terraform/|\.terraform/|\./\.venv/|\./\.dev/'
      ITEMS:
        sh: |
          find . -type f -name "*.sh" -not -path "./.git/*" -not -path "./node_modules/*" -not -path "*/.venv/*" -not -path "*/.dev/*" -not -path "*/.terraform/*" -not -path ".terraform/*"
    cmds:
      - for: { var: SHELL_FILES }
        cmd: shfmt -w -i 2 -ci -bn "{{osClean .ITEM}}"
      - for: { var: ITEMS }
        cmd: shellcheck "{{osClean .ITEM}}"
    dir: "{{.ROOT_DIR}}"
